<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bus Booking — Sleeper (All-in-One)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb;
    --brand:#22c55e; --blue:#3b82f6; --danger:#ef4444; --warn:#f59e0b; --blocked:#3a3a3a; --reserved:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(135deg,#0f172a,#081225); color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(0,0,0,0.35);border-bottom:1px solid #172033}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(45deg,var(--brand),var(--blue));box-shadow:0 6px 20px rgba(59,130,246,.18)}
  main{max-width:1100px;margin:20px auto;padding:0 12px;display:grid;gap:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));border:1px solid #172033;padding:14px;border-radius:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .space{justify-content:space-between}
  input,select,button{background:#071025;border:1px solid #1b2a3a;color:var(--text);padding:8px 10px;border-radius:8px}
  button{cursor:pointer}
  .btn{background:var(--blue);color:#fff;border-radius:8px;padding:8px 12px;border:none}
  .btn.alt{background:var(--brand)}
  .btn.ghost{background:transparent;border:1px solid #223246;color:var(--text)}
  .btn.warn{background:var(--warn)}
  .btn.danger{background:var(--danger)}
  .pill{padding:6px 10px;border-radius:999px;background:#071025;border:1px solid #223246}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #122233;background:linear-gradient(180deg,#061022,#020512)}
  .muted{color:#9aa6b6;font-size:13px}
  .divider{height:1px;background:#122233;margin:10px 0}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #122233;text-align:left}
  th{color:#cfe4ff}
  /* seat grid */
  .seat-wrap{display:grid;gap:8px;padding:12px;border-radius:10px;border:1px dashed #223246;background:#04101a}
  .seat{height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;user-select:none;border:1px solid #253645}
  .seat.free{background:#05351f;color:#c8ffde;border-color:#064e3b}
  .seat.selected{background:#06304b;color:#dbeeff;border-color:#1d4ed8;box-shadow:inset 0 0 0 3px rgba(59,130,246,.12)}
  .seat.reserved{background:#5a3b0a;color:#fff;border-color:#f59e0b}
  .seat.booked{background:#3a0d0d;color:#ffd7d7;border-color:#7f1d1d;text-decoration:line-through}
  .seat.blocked{background:#212121;color:#cbd5dd;border-color:#3b3b3b}
  .legend{display:flex;gap:10px;align-items:center}
  .sw{width:14px;height:14px;border-radius:3px;border:1px solid #233445}
  .sw.free{background:#05351f}
  .sw.sel{background:#06304b}
  .sw.res{background:#5a3b0a}
  .sw.book{background:#3a0d0d}
  .sw.block{background:#212121}
</style>
</head>
<body>
<header>
  <div class="brand"><div class="logo"></div>Bus Booking — Sleeper (All-in-One)</div>
  <div id="sessionArea" class="row"></div>
</header>

<main>
  <!-- INDEX -->
  <section id="page-index" class="card">
    <div class="row" style="gap:18px;align-items:flex-start">
      <div style="flex:1;min-width:320px">
        <div class="row" style="margin-bottom:8px">
          <button class="btn tab active" data-tab="loginTab">User Login</button>
          <button class="btn tab ghost" data-tab="signupTab">Sign Up</button>
          <button class="btn tab ghost" data-tab="adminTab">Admin</button>
        </div>

        <div id="loginTab">
          <h3>User Login</h3>
          <div class="row" style="margin-top:8px">
            <input id="loginUser" placeholder="Username"/>
            <input id="loginPass" type="password" placeholder="Password"/>
            <button class="btn" id="loginBtn">Login</button>
            <button class="btn ghost" id="gotoBookingBtn">Go to Booking</button>
          </div>
        </div>

        <div id="signupTab" class="hidden">
          <h3>Sign Up</h3>
          <div class="row" style="margin-top:8px">
            <input id="suUser" placeholder="Choose username"/>
            <input id="suPass" type="password" placeholder="Choose password"/>
            <button class="btn alt" id="signupBtn">Create</button>
          </div>
        </div>

        <div id="adminTab" class="hidden">
          <h3>Admin Login</h3>
          <div class="row" style="margin-top:8px">
            <input id="adminUser" placeholder="Admin ID (default admin)"/>
            <input id="adminPass" type="password" placeholder="Password (default admin123)"/>
            <button class="btn warn" id="adminLoginBtn">Admin Login</button>
            <button class="btn ghost" id="gotoAdminBtn">Go to Admin</button>
          </div>
        </div>
      </div>

      <div style="width:360px;min-width:240px">
        <div class="card">
          <h3>Quick Links</h3>
          <div class="row" style="margin-top:8px">
            <button class="pill btn" id="quickBooking">User Booking</button>
            <button class="pill btn ghost" id="quickAdmin">Admin Panel</button>
          </div>
          <div class="divider"></div>
          <div class="muted">Admin: <strong>admin</strong> / <strong>admin123</strong></div>
          <div class="muted" style="margin-top:6px">Sleeper layout: Lower (A/B/C 30 seats) & Upper (SL/SR/SP 15 seats) = 45 total.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- BOOKING -->
  <section id="page-booking" class="card hidden">
    <div class="row space">
      <div>
        <h3>Search & Booking</h3>
        <div class="muted">Search by route, date or bus number. For sleeper buses, switch Upper/Lower using tabs in seat area.</div>
      </div>
      <div class="row">
        <span class="pill" id="busCountPill">0 buses</span>
        <button class="btn ghost" id="backHome">Home</button>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <input id="fromInp" placeholder="From"/>
      <input id="toInp" placeholder="To"/>
      <input id="dateInp" type="date"/>
      <input id="busNoInp" placeholder="Bus No"/>
      <button class="btn" id="searchBtn">Search</button>
      <button class="btn ghost" id="resetBtn">Reset</button>
    </div>

    <div class="divider"></div>
    <div id="busList"></div>

    <div id="seatArea" class="card hidden" style="margin-top:12px">
      <div class="row space">
        <h3 id="seatTitle">Seat Map</h3>
        <div class="legend">
          <div class="sw sw.free"></div><div class="muted">Free</div>
          <div style="width:10px"></div>
          <div class="sw sw.sel"></div><div class="muted">Selected</div>
          <div style="width:10px"></div>
          <div class="sw sw.res"></div><div class="muted">Pending</div>
          <div style="width:10px"></div>
          <div class="sw sw.book"></div><div class="muted">Confirmed</div>
          <div style="width:10px"></div>
          <div class="sw sw.block"></div><div class="muted">Blocked</div>
        </div>
      </div>

      <!-- switcher for sleeper -->
      <div class="row" style="margin-top:8px">
        <div id="upperLowerTabs" class="row hidden">
          <button class="btn tabUL active" data-which="lower">Lower Deck</button>
          <button class="btn tabUL ghost" data-which="upper">Upper Deck</button>
        </div>
        <div style="margin-left:auto" class="muted">Fare: <span id="fareInfo">₹0</span></div>
      </div>

      <div id="seatWrap" class="seat-wrap" style="margin-top:12px"></div>

      <div class="row space" style="margin-top:12px">
        <div class="row"><div class="muted">Selected:</div><div id="selSeats" class="pill">None</div></div>
        <div class="row">
          <div class="muted">Total:</div><div id="totalFare" class="pill">₹0</div>
          <button class="btn alt" id="payBtn" disabled>Pay (Demo)</button>
        </div>
      </div>
    </div>

    <div id="paymentCard" class="card hidden" style="margin-top:12px">
      <h3>Payment (Demo)</h3>
      <div class="muted">This is demo payment. After paying, booking becomes Pending and admin must Confirm or Reject.</div>
      <div class="row" style="margin-top:8px">
        <select id="payMethod"><option>UPI</option><option>Card</option><option>NetBanking</option></select>
        <input id="payRef" placeholder="UPI ID or reference"/>
        <button class="btn" id="confirmPayBtn">Pay & Request Booking</button>
        <button class="btn ghost" id="cancelPayBtn">Cancel</button>
      </div>
    </div>

    <div id="myBookings" class="card hidden" style="margin-top:12px">
      <h3>My Bookings</h3>
      <table id="myBookingsTable"><thead><tr><th>PNR</th><th>Bus</th><th>Date</th><th>Seats</th><th>Amount</th><th>Status</th><th>Ticket</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="page-admin" class="card hidden">
    <div class="row space">
      <h3>Admin Panel</h3>
      <div class="row">
        <button class="btn ghost" id="adminHome">Home</button>
        <button class="btn danger" id="adminLogout">Logout</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="gap:8px">
      <input id="admBusNo" placeholder="Bus No (e.g., OD-05-1234 DRUTHI RATH)"/>
      <input id="admFrom" placeholder="From"/>
      <input id="admTo" placeholder="To"/>
      <input id="admDate" type="date"/>
      <input id="admTime" placeholder="Time (08:00 AM)"/>
      <input id="admPrice" type="number" placeholder="Price"/>
      <select id="admLayout"><option value="2x2_40">2+2 (40)</option><option value="2x1_30">2+1 (30)</option><option value="sleeper_45">Sleeper (45)</option></select>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="admBlocked" placeholder="Blocked seats comma separated (e.g. A1,B3,SL2)" style="flex:1"/>
      <button class="btn" id="saveBus">Save Bus</button>
      <button class="btn ghost" id="clearBus">Clear</button>
      <input type="hidden" id="editingBusId"/>
    </div>

    <div class="divider"></div>

    <div class="row space">
      <h4>All Buses</h4>
      <div class="row">
        <button class="btn ghost" id="exportBuses">Export Buses (CSV)</button>
        <button class="btn ghost" id="exportBookings">Export Bookings (CSV)</button>
      </div>
    </div>
    <div id="adminBusList" style="margin-top:8px"></div>

    <div class="divider"></div>

    <h4>All Bookings</h4>
    <table id="adminBookingsTable"><thead><tr><th>PNR</th><th>User</th><th>Bus</th><th>Date</th><th>Seats</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<footer style="text-align:center;color:#9aa6b6;padding:12px">Demo app — LocalStorage • Admin confirm/reject • PDF via jsPDF</footer>

<!-- tiny jsPDF (same minimal embedded builder used earlier) -->
<script>
!function(f){typeof define=="function"&&define.amd?define(f):f()}(function(){function e(){return window.jspdf||window.jsPDF}
if(!e()){var o=function(){return function(t){this.internal={};this.__pages=[[]];this.addPage=function(){this.__pages.push([]);return this};
this.text=function(txt,x,y,opts){this.__pages[this.__pages.length-1].push({t:txt,x:x,y:y});return this};
this.save=function(name){var pdf="%PDF-1.3\n";var body="";var objs=[];var pageRefs=[];function esc(s){return String(s).replace(/\\(/g,"\\\\(").replace(/\\)/g,"\\\\)")}
function pageStream(items){var c="BT\n/F1 12 Tf\n";items.forEach(function(it){c+=""+it.x+" "+(792-it.y)+" Td ("+esc(it.t)+") Tj\n"});c+="ET";return c}
function obj(id,content){objs.push({id:id,content:content})}
var font="<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>";
obj(1,"<< /Type /Catalog /Pages 2 0 R >>");
obj(2,"<< /Type /Pages /Kids [3 0 R] /Count 1 >>");
var stream=pageStream(this.__pages[0]||[]);
obj(4,font);
obj(3,"<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 5 0 R /Resources << /Font << /F1 4 0 R >> >> >>");
obj(5,"<< /Length "+stream.length+" >>\nstream\n"+stream+"\nendstream");
var xref="xref\n0 "+(objs.length+1)+"\n0000000000 65535 f \n",pos=pdf.length;
objs.forEach(function(o){var off=pdf.length;pdf+=o.id+" 0 obj\n"+o.content+"\nendobj\n";xref+=("0000000000"+off).slice(-10)+" 00000 n \n"});
var startxref=pdf.length;xref+=("0000000000"+pos).slice(-10)+" 00000 n \n";pdf+=xref+"trailer << /Size "+(objs.length+1)+" /Root 1 0 R >>\nstartxref\n"+startxref+"\n%%EOF";
var blob=new Blob([pdf],{type:"application/pdf"});var link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download=name||"file.pdf";link.click();URL.revokeObjectURL(link.href);};};window.jsPDF=o;window.jspdf={jsPDF:o};}});
</script>

<script>
/* ---------------------------
   LocalStorage helper + util
----------------------------*/
const DB = {
  load(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(e){ return d } },
  save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
};
const U = {
  qs: s=>document.querySelector(s), qsa:s=>Array.from(document.querySelectorAll(s)),
  id: ()=> (crypto?.randomUUID?.() || 'id'+Math.floor(Math.random()*1e9)),
  today: ()=> new Date().toISOString().slice(0,10),
  money: n => '₹'+Number(n).toLocaleString('en-IN'),
  show: id => { ['page-index','page-booking','page-admin'].forEach(p=>U.qs('#'+p).classList.add('hidden')); U.qs('#'+id).classList.remove('hidden'); renderSession(); }
};

/* ---------------------------
   Seat layouts (including sleeper 45)
   Seat naming consistent with provided PDF:
   Lower: A1..A10, B1..B10, C1..C10  => 30 seats
   Upper: SL1..SL5, SR1..SR5, SP1..SP5 => 15 seats
----------------------------*/
const Layouts = {
  "2x2_40": ()=>{ const arr=[]; for(let r=1;r<=10;r++){ ['A','B','C','D'].forEach(c=>arr.push(c+r)); } return arr; },
  "2x1_30": ()=>{ const arr=[]; for(let r=1;r<=10;r++){ ['A','B','C'].forEach(c=>arr.push(c+r)); } return arr; },
  "sleeper_45": ()=>{ const a=[]; for(let r=1;r<=10;r++){ ['A','B','C'].forEach(c=>a.push(c+r)); } for(let i=1;i<=5;i++){ a.push('SL'+i); } for(let i=1;i<=5;i++){ a.push('SR'+i); } for(let i=1;i<=5;i++){ a.push('SP'+i); } return a; }
};

/* ---------------------------
   Seed initial data
----------------------------*/
(function seed(){
  const users = DB.load('users', []);
  if(!users.find(u=>u.username==='admin')){ users.push({username:'admin',password:'admin123',role:'admin'}); DB.save('users',users); }
  if(!DB.load('buses', null)){
    const d=U.today();
    DB.save('buses', [
      makeBus({busNo:'DRUTHI RATH OD-05-1234', from:'Bhubaneswar', to:'Kolkata', date:d, time:'08:00 AM', price:550, layout:'sleeper_45', blocked:['A1','B1']}),
      makeBus({busNo:'SKYLINE OD-07-6688', from:'Bhubaneswar', to:'Delhi', date:d, time:'05:00 PM', price:1200, layout:'2x1_30', blocked:[]})
    ]);
  }
  if(DB.load('bookings', null)===null) DB.save('bookings', []);
  if(DB.load('session', null)===null) DB.save('session', null);
})();

function makeBus({busNo,from,to,date,time,price,layout,blocked=[]}){
  const names = Layouts[layout]();
  const seats = names.map(n => blocked.includes(n)?2:0); // 0 free,1 booked,2 blocked,3 reserved/pending
  return { id: U.id(), busNo, from, to, date, time, price:Number(price), layout, seatNames:names, seats };
}

/* ---------------------------
   Session & header
----------------------------*/
function getSession(){ return DB.load('session', null) }
function setSession(s){ DB.save('session', s); renderSession(); }
function clearSession(){ DB.save('session', null); renderSession(); U.show('page-index'); }

function renderSession(){
  const sa = U.qs('#sessionArea'); sa.innerHTML='';
  const s = getSession();
  if(s){
    sa.innerHTML = `<div class="row"><div class="pill">Signed in: ${s.username} ${s.role==='admin'? '(Admin)':''}</div><button class="btn ghost" id="logoutHeader">Logout</button></div>`;
    U.qs('#logoutHeader').onclick = ()=> { clearSession(); alert('Logged out'); }
  } else {
    sa.innerHTML = `<div class="muted">Not signed in</div>`;
  }
}

/* ---------------------------
   Index page logic (tabs + auth)
----------------------------*/
U.qsa('.tab').forEach(btn => btn.addEventListener('click', ()=>{
  U.qsa('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  ['loginTab','signupTab','adminTab'].forEach(id => U.qs('#'+id).classList.toggle('hidden', btn.dataset.tab !== id));
}));

U.qs('#loginBtn').onclick = ()=>{
  const u = U.qs('#loginUser').value.trim(), p = U.qs('#loginPass').value;
  const users = DB.load('users', []);
  const found = users.find(x=>x.username===u && x.password===p && x.role!=='admin');
  if(found){ setSession({username:u, role:'user'}); alert('Welcome '+u); U.show('page-booking'); renderBuses(); renderMyBookings(); } else alert('Invalid user credentials');
};
U.qs('#signupBtn').onclick = ()=>{
  const u = U.qs('#suUser').value.trim(), p = U.qs('#suPass').value;
  if(!u||!p){ alert('Enter username & password'); return; }
  const users = DB.load('users', []); if(users.find(x=>x.username===u)){ alert('Username exists'); return; }
  users.push({username:u,password:p,role:'user'}); DB.save('users',users); alert('Account created'); U.qs('[data-tab="loginTab"]').click();
};
U.qs('#adminLoginBtn').onclick = ()=>{
  const u = (U.qs('#adminUser').value.trim()||'admin'), p = (U.qs('#adminPass').value||'admin123');
  const users = DB.load('users', []); const ok = users.find(x=>x.username===u && x.password===p && x.role==='admin');
  if(ok){ setSession({username:u, role:'admin'}); alert('Admin logged in'); U.show('page-admin'); renderAdminBuses(); renderAdminBookings(); } else alert('Wrong admin credentials');
};

U.qs('#gotoBookingBtn').onclick = ()=>{ U.show('page-booking'); renderBuses(); renderMyBookings(); };
U.qs('#gotoAdminBtn').onclick = ()=>{ const s=getSession(); if(s?.role==='admin'){ U.show('page-admin'); renderAdminBuses(); renderAdminBookings(); } else U.show('page-index'); };
U.qs('#quickBooking').onclick = ()=>{ U.show('page-booking'); renderBuses(); renderMyBookings(); };
U.qs('#quickAdmin').onclick = ()=>{ if(getSession()?.role==='admin'){ U.show('page-admin'); renderAdminBuses(); renderAdminBookings(); } else U.show('page-index'); };

/* ---------------------------
   Booking: search + seat map
----------------------------*/
let currentBusId = null;
let selectedIdx = [];
let showingDeck = 'lower'; // 'lower' or 'upper' for sleeper

function renderBuses(filter=null){
  const buses = DB.load('buses', []);
  const list = U.qs('#busList'); list.innerHTML='';
  const filtered = filter ? buses.filter(filter) : buses;
  U.qs('#busCountPill').textContent = `${filtered.length} buses`;
  filtered.forEach(b=>{
    const free = b.seats.filter(s=>s===0).length, booked = b.seats.filter(s=>s===1).length;
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div>
      <div style="font-weight:700">${b.busNo}</div>
      <div class="muted">${b.from} → ${b.to} • ${b.date} • ${b.time}</div>
      <div class="muted">${U.money(b.price)} per seat • Free ${free} / ${b.seatNames.length}</div>
      </div>
      <div class="row"><button class="btn" data-id="${b.id}">View Seats</button></div>`;
    list.appendChild(div);
  });
  list.querySelectorAll('button').forEach(b=>b.onclick = ()=> openSeatMap(b.dataset.id));
}

U.qs('#searchBtn').onclick = ()=>{
  const f = U.qs('#fromInp').value.trim().toLowerCase();
  const t = U.qs('#toInp').value.trim().toLowerCase();
  const d = U.qs('#dateInp').value;
  const bn = U.qs('#busNoInp').value.trim().toLowerCase();
  renderBuses(bus=> (!f||bus.from.toLowerCase().includes(f)) && (!t||bus.to.toLowerCase().includes(t)) && (!d||bus.date===d) && (!bn||bus.busNo.toLowerCase().includes(bn)));
};
U.qs('#resetBtn').onclick = ()=>{ ['fromInp','toInp','dateInp','busNoInp'].forEach(id=>U.qs('#'+id).value=''); renderBuses(); };
U.qs('#backHome').onclick = ()=> U.show('page-index');

function openSeatMap(id){
  const buses = DB.load('buses', []); const bus = buses.find(x=>x.id===id); if(!bus) return alert('not found');
  currentBusId = id; selectedIdx = [];
  U.qs('#seatArea').classList.remove('hidden');
  U.qs('#paymentCard').classList.add('hidden');
  U.qs('#seatTitle').textContent = `Seats — ${bus.busNo} (${bus.from} → ${bus.to})`;
  // if sleeper layout, show upper/lower tabs
  if(bus.layout === 'sleeper_45'){ U.qs('#upperLowerTabs').classList.remove('hidden'); showingDeck='lower'; U.qsa('.tabUL').forEach(t=>t.classList.remove('active')); U.qs('.tabUL[data-which="lower"]').classList.add('active'); } else { U.qs('#upperLowerTabs').classList.add('hidden'); }
  renderSeatGrid(bus);
  updateFare();
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
}

U.qsa('.tabUL').forEach(btn=>btn.addEventListener('click', ()=>{
  U.qsa('.tabUL').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active'); showingDeck = btn.dataset.which;
  const bus = DB.load('buses', []).find(b=>b.id===currentBusId);
  if(bus) renderSeatGrid(bus);
}));

function renderSeatGrid(bus){
  const wrap = U.qs('#seatWrap'); wrap.innerHTML='';
  // Determine which seat subset to show if sleeper
  let indices = [];
  if(bus.layout === 'sleeper_45'){
    if(showingDeck === 'lower'){
      // lower: A1..A10, B1..B10, C1..C10 => indices 0..29
      indices = Array.from(Array(30).keys());
      wrap.style.gridTemplateColumns = 'repeat(3,1fr)';
    } else {
      // upper seats SL1..SL5 (30..34), SR1..SR5 (35..39), SP1..SP5 (40..44)
      indices = Array.from({length:15}, (_,i)=>30+i);
      wrap.style.gridTemplateColumns = 'repeat(5,1fr)';
    }
  } else {
    // non-sleeper: show all seats
    indices = Array.from({length:bus.seatNames.length}, (_,i)=>i);
    wrap.style.gridTemplateColumns = (bus.layout==='2x1_30') ? 'repeat(3,1fr)' : 'repeat(4,1fr)';
  }
  // create seat elements
  indices.forEach(i=>{
    const name = bus.seatNames[i]; const st = bus.seats[i];
    const el = document.createElement('div'); el.className='seat'; el.textContent = name;
    if(st===1) el.classList.add('booked');
    else if(st===2) el.classList.add('blocked');
    else if(st===3) el.classList.add('reserved');
    else if(selectedIdx.includes(i)) el.classList.add('selected');
    else el.classList.add('free');
    // only allow clicking if free
    el.onclick = ()=> {
      if(st!==0 && !selectedIdx.includes(i)){ /* blocked/booked/reserved, can't select */ return; }
      if(!getSession() || getSession().role!=='user'){ alert('Login as user to select seats'); U.show('page-index'); return; }
      if(selectedIdx.includes(i)) selectedIdx = selectedIdx.filter(x=>x!==i); else selectedIdx.push(i);
      renderSeatGrid(bus);
      updateFare();
    };
    wrap.appendChild(el);
  });
  U.qs('#fareInfo').textContent = U.money(bus.price);
}

function updateFare(){
  const bus = DB.load('buses', []).find(b=>b.id===currentBusId);
  if(!bus) return;
  const seatNames = selectedIdx.map(i=>bus.seatNames[i]);
  U.qs('#selSeats').textContent = seatNames.length ? seatNames.join(', ') : 'None';
  U.qs('#totalFare').textContent = U.money(seatNames.length * bus.price);
  U.qs('#payBtn').disabled = !(getSession()?.role==='user' && seatNames.length>0);
}

/* ---------------------------
   Payment (demo) => create pending booking (reserve seats)
----------------------------*/
U.qs('#payBtn').onclick = ()=> { U.qs('#paymentCard').classList.remove('hidden'); U.qs('#payRef').value=''; };
U.qs('#cancelPayBtn').onclick = ()=> U.qs('#paymentCard').classList.add('hidden');

U.qs('#confirmPayBtn').onclick = ()=>{
  const s = getSession(); if(!s || s.role!=='user') return alert('Login as user');
  const bus = DB.load('buses', []).find(b=>b.id===currentBusId); if(!bus) return;
  // check seat availability (not booked or blocked or reserved by another)
  if(selectedIdx.some(i => bus.seats[i]!==0)){ alert('Some seats were taken. Please reselect.'); openSeatMap(bus.id); return; }
  // mark seats as reserved (3)
  selectedIdx.forEach(i => bus.seats[i]=3);
  DB.save('buses', DB.load('buses', []));
  // create booking with status Pending
  const pnr = 'PNR' + Math.floor(100000 + Math.random()*900000);
  const amount = selectedIdx.length * bus.price;
  const booking = { id: U.id(), pnr, user: s.username, busId: bus.id, busNo: bus.busNo, route: `${bus.from}→${bus.to}`, date: bus.date, time: bus.time, seats: selectedIdx.map(i=>bus.seatNames[i]), amount, method: U.qs('#payMethod').value, ref: U.qs('#payRef').value||'(demo)', status:'Pending', ts: Date.now(), pdf:false };
  const bookings = DB.load('bookings', []); bookings.push(booking); DB.save('bookings',bookings);
  // clear selection
  selectedIdx = []; U.qs('#paymentCard').classList.add('hidden');
  alert('Booking requested. Status: Pending. Admin will confirm or reject shortly.');
  renderSeatGrid(bus); renderBuses(); renderMyBookings(); renderAdminBookings();
};

/* ---------------------------
   My Bookings (user) - shows Pending/Confirmed/Rejected and download ticket if confirmed
----------------------------*/
function renderMyBookings(){
  const s = getSession(); const wrap = U.qs('#myBookings'); const tbody = U.qs('#myBookingsTable tbody'); tbody.innerHTML='';
  if(!(s && s.role==='user')){ wrap.classList.add('hidden'); return; }
  const bookings = DB.load('bookings', []).filter(b=>b.user===s.username).sort((a,b)=>b.ts-b.ts);
  bookings.forEach(b=>{
    const tr = document.createElement('tr');
    const ticketBtn = (b.status==='Confirmed') ? `<button class="btn" data-pnr="${b.pnr}" data-action="dl">Download</button>` : (b.status==='Pending' ? 'Pending' : 'Rejected');
    tr.innerHTML = `<td>${b.pnr}</td><td>${b.busNo}</td><td>${b.date}</td><td>${b.seats.join(', ')}</td><td>${U.money(b.amount)}</td><td>${b.status}</td><td>${ticketBtn}</td>`;
    tbody.appendChild(tr);
  });
  // download handlers
  U.qsa('[data-action="dl"]').forEach(btn=> btn.onclick = (e)=> {
    const pnr = btn.dataset.pnr; const b = DB.load('bookings', []).find(x=>x.pnr===pnr);
    if(!b) return; const bus = DB.load('buses',[]).find(x=>x.id===b.busId); generateTicketPDF(b, bus);
  });
  wrap.classList.remove('hidden');
}

/* ---------------------------
   Admin: buses list, bookings, confirm/reject, export CSV
----------------------------*/
function adminCheck(){ const s=getSession(); if(!s || s.role!=='admin'){ alert('Admin only'); U.show('page-index'); return false } return true; }

function renderAdminBuses(){
  const wrap = U.qs('#adminBusList'); wrap.innerHTML=''; const buses = DB.load('buses', []);
  buses.forEach(b=>{
    const booked = b.seats.filter(x=>x===1).length, reserved = b.seats.filter(x=>x===3).length, blocked = b.seats.filter(x=>x===2).length;
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div>
      <div style="font-weight:700">${b.busNo}</div>
      <div class="muted">${b.from}→${b.to} • ${b.date} • ${b.time} • ${b.seatNames.length} seats</div>
      <div class="muted">Booked:${booked} • Pending:${reserved} • Blocked:${blocked} • Price:${U.money(b.price)}</div>
    </div>
    <div class="row"><button class="btn ghost" data-act="edit" data-id="${b.id}">Edit</button><button class="btn danger" data-act="del" data-id="${b.id}">Delete</button></div>`;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll('button[data-act="edit"]').forEach(btn=>btn.onclick = ()=> loadBusForEdit(btn.dataset.id));
  wrap.querySelectorAll('button[data-act="del"]').forEach(btn=>btn.onclick = ()=> { if(confirm('Delete bus?')){ DB.save('buses', DB.load('buses',[]).filter(x=>x.id!==btn.dataset.id)); renderAdminBuses(); renderBuses(); }});
}

function renderAdminBookings(){
  if(!adminCheck()) return;
  const tbody = U.qs('#adminBookingsTable tbody'); tbody.innerHTML='';
  const bookings = DB.load('bookings', []).sort((a,b)=>b.ts-a.ts);
  bookings.forEach(b=>{
    const tr = document.createElement('tr');
    const actions = (b.status==='Pending') ? `<button class="btn" data-pnr="${b.pnr}" data-act="confirm">Confirm</button> <button class="btn danger" data-pnr="${b.pnr}" data-act="reject">Reject</button>` : (b.status==='Confirmed' ? 'Confirmed' : 'Rejected');
    tr.innerHTML = `<td>${b.pnr}</td><td>${b.user}</td><td>${b.busNo}</td><td>${b.date}</td><td>${b.seats.join(', ')}</td><td>${U.money(b.amount)}</td><td>${b.status}</td><td>${actions}</td>`;
    tbody.appendChild(tr);
  });
  // bind confirm/reject
  U.qsa('[data-act="confirm"]').forEach(btn=> btn.onclick = ()=> adminConfirm(btn.dataset.pnr));
  U.qsa('[data-act="reject"]').forEach(btn=> btn.onclick = ()=> adminReject(btn.dataset.pnr));
}

function adminConfirm(pnr){
  if(!adminCheck()) return;
  const bookings = DB.load('bookings', []); const b = bookings.find(x=>x.pnr===pnr); if(!b) return alert('Booking not found');
  if(b.status!=='Pending') return alert('Already processed');
  // mark booking confirmed and update bus seats (reserved->booked)
  const buses = DB.load('buses', []); const bus = buses.find(x=>x.id===b.busId);
  // for each seat name in booking, find index and set to 1
  b.seats.forEach(sname=>{
    const idx = bus.seatNames.indexOf(sname); if(idx>=0) bus.seats[idx]=1;
  });
  b.status='Confirmed'; b.confirmedAt = Date.now(); b.pdf = true; // mark PDF generated later
  DB.save('buses', buses); DB.save('bookings', bookings);
  alert('Booking confirmed — PDF ticket will be generated for record download.');
  // generate and download PDF for admin (and user can download later)
  generateTicketPDF(b, bus);
  renderAdminBuses(); renderAdminBookings(); renderBuses(); renderMyBookings();
}

function adminReject(pnr){
  if(!adminCheck()) return;
  if(!confirm('Reject this booking?')) return;
  const bookings = DB.load('bookings', []); const b = bookings.find(x=>x.pnr===pnr); if(!b) return;
  if(b.status!=='Pending') return alert('Already processed');
  // release reserved seats: find bus, set seats with those names from 3 -> 0
  const buses = DB.load('buses', []); const bus = buses.find(x=>x.id===b.busId);
  b.seats.forEach(sname=>{
    const idx = bus.seatNames.indexOf(sname); if(idx>=0 && bus.seats[idx]===3) bus.seats[idx]=0;
  });
  b.status='Rejected'; DB.save('buses', buses); DB.save('bookings', bookings);
  alert('Booking rejected and seats released.');
  renderAdminBuses(); renderAdminBookings(); renderBuses(); renderMyBookings();
}

/* ---------------------------
   Admin: load/edit bus
----------------------------*/
function loadBusForEdit(id){
  const bus = DB.load('buses', []).find(x=>x.id===id); if(!bus) return;
  U.qs('#editingBusId').value = bus.id;
  U.qs('#admBusNo').value = bus.busNo; U.qs('#admFrom').value = bus.from; U.qs('#admTo').value = bus.to;
  U.qs('#admDate').value = bus.date; U.qs('#admTime').value = bus.time; U.qs('#admPrice').value = bus.price; U.qs('#admLayout').value = bus.layout;
  const blocked = bus.seatNames.filter((n,i)=>bus.seats[i]===2);
  U.qs('#admBlocked').value = blocked.join(',');
  window.scrollTo({top:0,behavior:'smooth'});
}

U.qs('#clearBus').onclick = ()=> { ['admBusNo','admFrom','admTo','admDate','admTime','admPrice','admBlocked','editingBusId'].forEach(id=>U.qs('#'+id).value=''); U.qs('#admLayout').value='sleeper_45'; }

U.qs('#saveBus').onclick = ()=> {
  if(!adminCheck()) return;
  const busNo = U.qs('#admBusNo').value.trim(), from=U.qs('#admFrom').value.trim(), to=U.qs('#admTo').value.trim();
  const date=U.qs('#admDate').value, time=U.qs('#admTime').value.trim(), price=Number(U.qs('#admPrice').value), layout=U.qs('#admLayout').value;
  const blockedRaw = U.qs('#admBlocked').value.trim(); const blocked = blockedRaw? blockedRaw.split(',').map(s=>s.trim()).filter(Boolean):[];
  if(!busNo||!from||!to||!date||!time||!price) return alert('Fill all fields');
  let buses = DB.load('buses', []);
  const editing = U.qs('#editingBusId').value;
  if(editing){
    const idx = buses.findIndex(x=>x.id===editing);
    if(idx>-1){
      const old = buses[idx];
      // if layout unchanged keep booked seats; otherwise rebuild mapping
      const seatNames = (old.layout === layout) ? old.seatNames.slice() : Layouts[layout]();
      let seats = seatNames.map(n=> blocked.includes(n)?2:0);
      if(old.layout===layout){
        // preserve booked seats
        old.seatNames.forEach((n,i)=>{ const pos = seatNames.indexOf(n); if(pos>=0 && old.seats[i]===1) seats[pos]=1; });
      }
      buses[idx] = { ...old, busNo, from, to, date, time, price, layout, seatNames, seats };
    }
  } else {
    buses.push(makeBus({busNo, from, to, date, time, price, layout, blocked}));
  }
  DB.save('buses', buses);
  alert('Saved');
  renderAdminBuses(); renderBuses();
};

/* ---------------------------
   Exports (CSV)
----------------------------*/
function downloadCSV(fn, rows){
  const csv = rows.map(r => r.map(c => '"'+(c??'').toString().replace(/"/g,'""') +'"').join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=fn; a.click(); URL.revokeObjectURL(url);
}
U.qs('#exportBuses').onclick = ()=> {
  if(!adminCheck()) return;
  const rows = [['BusNo','From','To','Date','Time','Price','Layout','TotalSeats','Booked','Reserved','Blocked']];
  DB.load('buses', []).forEach(b=>{
    rows.push([b.busNo,b.from,b.to,b.date,b.time,b.price,b.layout,b.seatNames.length,b.seats.filter(x=>x===1).length,b.seats.filter(x=>x===3).length,b.seats.filter(x=>x===2).length]);
  });
  downloadCSV('buses.csv', rows);
};
U.qs('#exportBookings').onclick = ()=> {
  if(!adminCheck()) return;
  const rows = [['PNR','User','BusNo','Route','Date','Time','Seats','Amount','Method','Ref','Status','BookedAt']];
  DB.load('bookings', []).forEach(b=>{
    rows.push([b.pnr,b.user,b.busNo,b.route,b.date,b.time,b.seats.join(' '),b.amount,b.method,b.ref,b.status, new Date(b.ts).toLocaleString()]);
  });
  downloadCSV('bookings.csv', rows);
};

/* ---------------------------
   Ticket PDF generation (simple)
   - uses embedded jsPDF tiny builder
----------------------------*/
// Generate PDF ticket
try {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Bus Ticket Confirmation", 20, 20);

  doc.setFontSize(12);
  doc.text(`PNR: ${pnr}`, 20, 35);
  doc.text(`Passenger: ${s.username}`, 20, 45);
  doc.text(`Bus No: ${bus.busNo || 'N/A'}`, 20, 55);
  doc.text(`Route: ${bus.from} → ${bus.to}`, 20, 65);
  doc.text(`Date: ${bus.date}   Time: ${bus.time}`, 20, 75);
  doc.text(`Seats: ${selectedSeats.map(i=>i+1).join(', ')}`, 20, 85);
  doc.text(`Amount Paid: ₹${amount}`, 20, 95);
  doc.text(`Status: CONFIRMED (Subject to Admin Approval)`, 20, 105);

  // save as Ticket_PNRxxxx.pdf
  doc.save(`Ticket_${pnr}.pdf`);

  alert('Payment successful! PDF Ticket downloaded.');
} catch (err) {
  console.error("PDF error:", err);
  alert("PDF generation failed. Check console.");
}

/* ---------------------------
   Admin confirm/reject actions already defined above call render functions
----------------------------*/

/* ---------------------------
   Initial render
----------------------------*/
(function init(){
  renderSession();
  const s = getSession();
  if(s?.role==='user'){ U.show('page-booking'); renderBuses(); renderMyBookings(); }
  else if(s?.role==='admin'){ U.show('page-admin'); renderAdminBuses(); renderAdminBookings(); }
  else { U.show('page-index'); }
  renderBuses();
  renderAdminBuses();
  renderAdminBookings();
})();
</script>
</body>
</html>
